<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenNI2 SDK: Code samples</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png" height="44"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><span style="font-family:Georgia">OpenNI2 SDK</span>
   &#160;<span id="projectnumber", style="font-family:Georgia">v2.3.0.66</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Code samples </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Currently, we have sample code to read the color stream, depth stream, ir stream, and point cloud using the OpenNI2 SDK, as well as to generate and read ONI video files, which will be described in detail below.The following samples are in the OpenNI2 Samples directory of the OpenNI2 SDK. You can use CMake to generate the openni2 examples.sln solution under Windows and the executable files under Linux.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">System  </th><th class="markdownTableHeadNone">Language  </th><th class="markdownTableHeadNone">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ColorReaderPoll  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read a color stream by polling.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">ColorReaderEvent  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read a color stream by event.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ColorReaderUVC  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read a color stream by UVC.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">DepthReaderPoll  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read a depth stream by polling.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">DepthReaderEvent  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read a depth stream by event.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">InfraredReaderPoll  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read an ir stream by polling.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">InfraredReaderEvent  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read an ir stream by event.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">GeneratePointCloud  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to generate a point cloud from depth frame data.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">InfraredOniFileRecorder  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to save an ir stream as an Oni file.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">InfraredOniFileReader  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read an ir stream from an Oni file.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">RGBSNReader  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read SN of RGB. Currently only Astra+ support this interface.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">HardwareD2C  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to use hardware D2C interface.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SoftD2C  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to use software D2C interface.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">MultiDepthViewer  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to get multiple devices depth data.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MultipleStreamRead  </td><td class="markdownTableBodyNone">Windows  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to get multiple stream of single device.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">ClosestPointViewer  </td><td class="markdownTableBodyNone">Linux  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to get closest point data.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">EventBasedRead  </td><td class="markdownTableBodyNone">Linux  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to get depth data by event.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">MultiDepthViewer  </td><td class="markdownTableBodyNone">Linux  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to get multiple devices depth data.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MultipleStreamRead  </td><td class="markdownTableBodyNone">Linux  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to get multiple stream of single device.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">SimpleRead  </td><td class="markdownTableBodyNone">Linux  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read a depth stream.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SimpleViewer  </td><td class="markdownTableBodyNone">Linux  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read and display a depth stream.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">RGBSNReader  </td><td class="markdownTableBodyNone">Linux  </td><td class="markdownTableBodyNone">C++  </td><td class="markdownTableBodyNone">This sample show how to read SN of RGB. Currently only Astra+ support this interface.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">colorforopenni2  </td><td class="markdownTableBodyNone">Android  </td><td class="markdownTableBodyNone">NDK  </td><td class="markdownTableBodyNone">This sample show how to read a color stream by NDK.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">depthforopenni2  </td><td class="markdownTableBodyNone">Android  </td><td class="markdownTableBodyNone">NDK  </td><td class="markdownTableBodyNone">This sample show how to read a depth stream by NDK.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">irforopenni2  </td><td class="markdownTableBodyNone">Android  </td><td class="markdownTableBodyNone">NDK  </td><td class="markdownTableBodyNone">This sample show how to read a ir stream by NDK.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">colorforopenni2（Java）  </td><td class="markdownTableBodyNone">Android  </td><td class="markdownTableBodyNone">Java  </td><td class="markdownTableBodyNone">This sample show how to read a color stream by Java.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">depthforopenni2（Java）  </td><td class="markdownTableBodyNone">Android  </td><td class="markdownTableBodyNone">Java  </td><td class="markdownTableBodyNone">This sample show how to read a depth stream by Java.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">irforopenni2（Java）  </td><td class="markdownTableBodyNone">Android  </td><td class="markdownTableBodyNone">Java  </td><td class="markdownTableBodyNone">This sample show how to read a ir stream by Java.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">OrbbecStreamSample  </td><td class="markdownTableBodyNone">Android  </td><td class="markdownTableBodyNone">Java  </td><td class="markdownTableBodyNone">This sample show how to read and display depth,color and ir stream.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">RGBSNReader  </td><td class="markdownTableBodyNone">Android  </td><td class="markdownTableBodyNone">Java  </td><td class="markdownTableBodyNone">This sample show how to read SN of RGB. Currently only Astra+ support this interface.   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md27"></a>
ColorReaderPoll</h1>
<p>This sample show how to read a color stream by polling.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Expected Output</h2>
<div class="image">
<img src="openni2_rgb_sample_res.png" alt="openni2_rgb_sample_res.png"/>
</div>
<h2><a class="anchor" id="autotoc_md29"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;OpenNI.h&gt;</span></div></div><!-- fragment --><p>Next, we need to initialize the OpenNI2 SDK, get sensor and create reader to read color stream.</p>
<div class="fragment"><div class="line"><span class="comment">//initialize openni sdk</span></div><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Initialize failed\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"></div><div class="line">Device device;</div><div class="line"></div><div class="line"><span class="comment">//open device</span></div><div class="line">rc = device.open(ANY_DEVICE);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t open device\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 2;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream color;</div><div class="line"></div><div class="line"><span class="comment">//create color stream</span></div><div class="line"><span class="keywordflow">if</span> (device.getSensorInfo(SENSOR_COLOR) != NULL)</div><div class="line">{</div><div class="line">    rc = color.create(device, SENSOR_COLOR);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Couldn&#39;t create depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">return</span> 3;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//start color stream</span></div><div class="line">rc = color.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t start the depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 4;</div><div class="line">}</div></div><!-- fragment --><p>Now, let's see how to get color frame.</p>
<div class="fragment"><div class="line">VideoFrameRef frame;</div><div class="line">RGB888Pixel* pColor;</div><div class="line"></div><div class="line"><span class="keywordflow">while</span> (!wasKeyboardHit())</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> changedStreamDummy;</div><div class="line">    VideoStream* pStream = &amp;color;</div><div class="line"></div><div class="line">    <span class="comment">//wait a new frame</span></div><div class="line">    rc = OpenNI::waitForAnyStream(&amp;pStream, 1, &amp;changedStreamDummy, SAMPLE_READ_WAIT_TIMEOUT);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Wait failed! (timeout is %d ms)\n%s\n&quot;</span>, SAMPLE_READ_WAIT_TIMEOUT, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//get color frame</span></div><div class="line">    rc = color.readFrame(&amp;frame);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Read failed!\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//check if the frame format is rgb888 frame format</span></div><div class="line">    <span class="keywordflow">if</span> (frame.getVideoMode().getPixelFormat() != PIXEL_FORMAT_RGB888)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Unexpected frame format\n&quot;</span>);</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight() + 1)*frame.getWidth() / 2;</div><div class="line"></div><div class="line">    pColor = (RGB888Pixel*)frame.getData();</div><div class="line"></div><div class="line">    <span class="comment">//print the r g b value of the middle pixel of the frame</span></div><div class="line">    printf(<span class="stringliteral">&quot;[%08llu] 0x%02x%02x%02x\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)frame.getTimestamp(),</div><div class="line">        pColor[middleIndex].r&amp;0xff,</div><div class="line">        pColor[middleIndex].g&amp;0xff,</div><div class="line">        pColor[middleIndex].b&amp;0xff);</div><div class="line">}</div></div><!-- fragment --><p>After all, we need to release all resources.</p>
<div class="fragment"><div class="line"><span class="comment">//stop color stream</span></div><div class="line">color.stop();</div><div class="line"></div><div class="line"><span class="comment">//destroy color stream</span></div><div class="line">color.destroy();</div><div class="line"></div><div class="line"><span class="comment">//close device</span></div><div class="line">device.close();</div><div class="line"></div><div class="line"><span class="comment">//shutdown OpenNI</span></div><div class="line">OpenNI::shutdown();</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md30"></a>
ColorReaderEvent</h1>
<p>This sample show how to read color stream with OpenNI2 SDK by event.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Expected Output</h2>
<div class="image">
<img src="openni2_rgb_sample_res.png" alt="openni2_rgb_sample_res.png"/>
</div>
<h2><a class="anchor" id="autotoc_md32"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;OpenNI.h&quot;</span></div></div><!-- fragment --><p>Next, we need to initialize the OpenNI2 SDK, get sensor and create reader to read color stream.</p>
<div class="fragment"><div class="line"><span class="comment">//initialize openNI sdk</span></div><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Initialize failed\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//open deivce</span></div><div class="line">Device device;</div><div class="line">rc = device.open(ANY_DEVICE);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t open device\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 2;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream color;</div><div class="line"></div><div class="line"><span class="comment">//create color stream</span></div><div class="line"><span class="keywordflow">if</span> (device.getSensorInfo(SENSOR_COLOR) != NULL)</div><div class="line">{</div><div class="line">    rc = color.create(device, SENSOR_COLOR);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Couldn&#39;t create depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//start color stream</span></div><div class="line">rc = color.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t start the depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">}</div></div><!-- fragment --><p>Then, we register a callback to receive color frame.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> analyzeFrame(<span class="keyword">const</span> VideoFrameRef&amp; frame)</div><div class="line">{</div><div class="line">    RGB888Pixel* pColor;</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight()+1)*frame.getWidth()/2;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (frame.getVideoMode().getPixelFormat())</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> PIXEL_FORMAT_RGB888:</div><div class="line">        pColor = (RGB888Pixel*)frame.getData();</div><div class="line">        printf(<span class="stringliteral">&quot;[%08llu] 0x%02x%02x%02x\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)frame.getTimestamp(),</div><div class="line">            pColor[middleIndex].r&amp;0xff,</div><div class="line">            pColor[middleIndex].g&amp;0xff,</div><div class="line">            pColor[middleIndex].b&amp;0xff);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        printf(<span class="stringliteral">&quot;Unknown format\n&quot;</span>);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class </span>PrintCallback : <span class="keyword">public</span> VideoStream::NewFrameListener</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keywordtype">void</span> onNewFrame(VideoStream&amp; stream)</div><div class="line">    {</div><div class="line">        stream.readFrame(&amp;m_frame);</div><div class="line"></div><div class="line">        analyzeFrame(m_frame);</div><div class="line">    }</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    VideoFrameRef m_frame;</div><div class="line">};</div><div class="line"></div><div class="line">PrintCallback colorPrinter;</div><div class="line"></div><div class="line"><span class="comment">// Register frame listener</span></div><div class="line">color.addNewFrameListener(&amp;colorPrinter);</div></div><!-- fragment --><p>Need to call update.</p>
<div class="fragment"><div class="line"><span class="comment">// Wait while we&#39;re getting frames through the printer</span></div><div class="line"><span class="keywordflow">while</span> (!wasKeyboardHit())</div><div class="line">{</div><div class="line">    Sleep(100);</div><div class="line">}</div></div><!-- fragment --><p>Once we don't need to receive frame anymore, remove listener.</p>
<div class="fragment"><div class="line">color.removeNewFrameListener(&amp;colorPrinter);</div></div><!-- fragment --><p>After all, we need to release all resources.</p>
<div class="fragment"><div class="line"><span class="comment">//stop color stream</span></div><div class="line">color.stop();</div><div class="line"></div><div class="line"><span class="comment">//destroy color stream</span></div><div class="line">color.destroy();</div><div class="line"></div><div class="line"><span class="comment">//close device</span></div><div class="line">device.close();</div><div class="line"></div><div class="line"><span class="comment">//shutdown OpenNI</span></div><div class="line">OpenNI::shutdown();</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md33"></a>
ColorReaderUVC</h1>
<h2><a class="anchor" id="autotoc_md34"></a>
Overview</h2>
<p>This sample show how to use OpenCV to open the UVC protocol's color camera and read the color stream.</p>
<h2><a class="anchor" id="autotoc_md35"></a>
Expected Output</h2>
<div class="image">
<img src="uvc_sample_res.png" alt="uvc_sample_res.png"/>
</div>
<h2><a class="anchor" id="autotoc_md36"></a>
Code Overview</h2>
<p>The OpenNI2 SDK does not support the color camera of the standard UVC protocol, so we provide a way to access the UVC color camera based on the VideoCapture class in OpenCV.</p>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;opencv2/opencv.hpp&gt;</span></div></div><!-- fragment --><p>Next, we need to create a cv::VideoCapture object and open the UVC camera. </p><div class="fragment"><div class="line"><span class="keyword">using namespace </span>cv;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    VideoCapture videoCapture;</div><div class="line"></div><div class="line">    videoCapture.open(0); </div><div class="line">    <span class="keywordflow">if</span> (!videoCapture.isOpened())</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;open UVC color camera failed.&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Now, we set the video encoding format and resolution.</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span>cv;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    VideoCapture videoCapture;</div><div class="line"></div><div class="line">    videoCapture.open(0);</div><div class="line">    <span class="keywordflow">if</span> (!videoCapture.isOpened())</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;open UVC color camera failed.&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//set codec format</span></div><div class="line">    videoCapture.set(CV_CAP_PROP_FOURCC, CV_FOURCC(<span class="charliteral">&#39;M&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;P&#39;</span>, <span class="charliteral">&#39;G&#39;</span>));</div><div class="line"></div><div class="line">    <span class="comment">//set resolution</span></div><div class="line">    videoCapture.set(CV_CAP_PROP_FRAME_WIDTH, 640);</div><div class="line">    videoCapture.set(CV_CAP_PROP_FRAME_HEIGHT, 480);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Finally, we read the color video stream and print out the values of the r, g, and b components of the middle pixel.</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span>cv;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    VideoCapture videoCapture;</div><div class="line"></div><div class="line">    videoCapture.open(cv::CAP_ANY);</div><div class="line">    <span class="keywordflow">if</span> (!videoCapture.isOpened())</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;open UVC color camera failed.&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//set codec format</span></div><div class="line">    videoCapture.set(CV_CAP_PROP_FOURCC, CV_FOURCC(<span class="charliteral">&#39;M&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;P&#39;</span>, <span class="charliteral">&#39;G&#39;</span>));</div><div class="line"></div><div class="line">    <span class="comment">//set resolution</span></div><div class="line">    videoCapture.set(CV_CAP_PROP_FRAME_WIDTH, 640);</div><div class="line">    videoCapture.set(CV_CAP_PROP_FRAME_HEIGHT, 480);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div><div class="line">    {</div><div class="line">        Mat frame; </div><div class="line">        videoCapture &gt;&gt; frame; </div><div class="line"></div><div class="line">        Vec3b &amp;bgr = frame.at&lt;Vec3b&gt;(frame.rows/2, frame.cols/2);</div><div class="line"></div><div class="line">        <span class="comment">//print the r g b value of the middle pixel of the frame</span></div><div class="line">        printf(<span class="stringliteral">&quot;r = %02d, g = %02d, b = %02d\n&quot;</span>,</div><div class="line">            bgr[2] &amp; 0xff,</div><div class="line">            bgr[1] &amp; 0xff,</div><div class="line">            bgr[0] &amp; 0xff);</div><div class="line"></div><div class="line">        waitKey(30); <span class="comment">//delay 30ms</span></div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md37"></a>
DepthReaderPoll</h1>
<h2><a class="anchor" id="autotoc_md38"></a>
Overview</h2>
<p>This sample show how to read a depth stream by polling.</p>
<h2><a class="anchor" id="autotoc_md39"></a>
Expected Output</h2>
<div class="image">
<img src="openni2_depth_sample_res.png" alt="openni2_depth_sample_res.png"/>
</div>
<h2><a class="anchor" id="autotoc_md40"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;OpenNI.h&gt;</span></div></div><!-- fragment --><p>Next, we need to initialize the OpenNI2 SDK, get sensor and create reader to read depth stream.</p>
<div class="fragment"><div class="line"><span class="comment">//initialize openni sdk</span></div><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Initialize failed\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"></div><div class="line">Device device;</div><div class="line"></div><div class="line"><span class="comment">//open device</span></div><div class="line">rc = device.open(ANY_DEVICE);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t open device\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 2;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream depth;</div><div class="line"></div><div class="line"><span class="comment">//create depth stream</span></div><div class="line"><span class="keywordflow">if</span> (device.getSensorInfo(SENSOR_DEPTH) != NULL)</div><div class="line">{</div><div class="line">    rc = depth.create(device, SENSOR_DEPTH);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Couldn&#39;t create depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">return</span> 3;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//start depth stream</span></div><div class="line">rc = depth.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t start the depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 4;</div><div class="line">}</div></div><!-- fragment --><p>Now, let's see how to get depth frame.</p>
<div class="fragment"><div class="line">VideoFrameRef frame;</div><div class="line"></div><div class="line"><span class="keywordflow">while</span> (!wasKeyboardHit())</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> changedStreamDummy;</div><div class="line">    VideoStream* pStream = &amp;depth;</div><div class="line"></div><div class="line">    <span class="comment">//wait a new frame</span></div><div class="line">    rc = OpenNI::waitForAnyStream(&amp;pStream, 1, &amp;changedStreamDummy, SAMPLE_READ_WAIT_TIMEOUT);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Wait failed! (timeout is %d ms)\n%s\n&quot;</span>, SAMPLE_READ_WAIT_TIMEOUT, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//get depth frame</span></div><div class="line">    rc = depth.readFrame(&amp;frame);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Read failed!\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//check if the frame format is depth frame format</span></div><div class="line">    <span class="keywordflow">if</span> (frame.getVideoMode().getPixelFormat() != PIXEL_FORMAT_DEPTH_1_MM &amp;&amp; frame.getVideoMode().getPixelFormat() != PIXEL_FORMAT_DEPTH_100_UM)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Unexpected frame format\n&quot;</span>);</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="namespaceopenni.html#ab2403242071ff06fc6fe18c0c6111d0f">DepthPixel</a>* pDepth = (<a class="code" href="namespaceopenni.html#ab2403242071ff06fc6fe18c0c6111d0f">DepthPixel</a>*)frame.getData();</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight() + 1)*frame.getWidth() / 2;</div><div class="line"></div><div class="line">    <span class="comment">//print the depth value of the middle pixel of the frame</span></div><div class="line">    printf(<span class="stringliteral">&quot;[%08llu] %8d\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)frame.getTimestamp(), pDepth[middleIndex]);</div><div class="line">}</div></div><!-- fragment --><p>After all, we need to release all resources.</p>
<div class="fragment"><div class="line"><span class="comment">//stop depth stream</span></div><div class="line">depth.stop();</div><div class="line"></div><div class="line"><span class="comment">//destroy depth stream</span></div><div class="line">depth.destroy();</div><div class="line"></div><div class="line"><span class="comment">//close device</span></div><div class="line">device.close();</div><div class="line"></div><div class="line"><span class="comment">//shutdown OpenNI</span></div><div class="line">OpenNI::shutdown();</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md41"></a>
DepthReaderEvent</h1>
<h2><a class="anchor" id="autotoc_md42"></a>
Overview</h2>
<p>This sample show how to read a depth stream by event.</p>
<h2><a class="anchor" id="autotoc_md43"></a>
Expected Output</h2>
<div class="image">
<img src="openni2_depth_sample_res.png" alt="openni2_depth_sample_res.png"/>
</div>
<h2><a class="anchor" id="autotoc_md44"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;OpenNI.h&quot;</span></div></div><!-- fragment --><p>Next, we need to initialize the OpenNI2 SDK, get sensor and create reader to read depth stream.</p>
<div class="fragment"><div class="line"><span class="comment">//initialize openNI sdk</span></div><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Initialize failed\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//open deivce</span></div><div class="line">Device device;</div><div class="line">rc = device.open(ANY_DEVICE);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t open device\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 2;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream depth;</div><div class="line"></div><div class="line"><span class="comment">//create depth stream</span></div><div class="line"><span class="keywordflow">if</span> (device.getSensorInfo(SENSOR_DEPTH) != NULL)</div><div class="line">{</div><div class="line">    rc = depth.create(device, SENSOR_DEPTH);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Couldn&#39;t create depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//start depth stream</span></div><div class="line">rc = depth.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t start the depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">}</div></div><!-- fragment --><p>Then, we register a callback to receive depth frame.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> analyzeFrame(<span class="keyword">const</span> VideoFrameRef&amp; frame)</div><div class="line">{</div><div class="line">    <a class="code" href="namespaceopenni.html#ab2403242071ff06fc6fe18c0c6111d0f">DepthPixel</a>* pDepth;</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight()+1)*frame.getWidth()/2;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (frame.getVideoMode().getPixelFormat())</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> PIXEL_FORMAT_DEPTH_1_MM:</div><div class="line">    <span class="keywordflow">case</span> PIXEL_FORMAT_DEPTH_100_UM:</div><div class="line">        pDepth = (<a class="code" href="namespaceopenni.html#ab2403242071ff06fc6fe18c0c6111d0f">DepthPixel</a>*)frame.getData();</div><div class="line">        printf(<span class="stringliteral">&quot;[%08llu] %8d\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)frame.getTimestamp(),</div><div class="line">            pDepth[middleIndex]);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        printf(<span class="stringliteral">&quot;Unknown format\n&quot;</span>);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class </span>PrintCallback : <span class="keyword">public</span> VideoStream::NewFrameListener</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keywordtype">void</span> onNewFrame(VideoStream&amp; stream)</div><div class="line">    {</div><div class="line">        stream.readFrame(&amp;m_frame);</div><div class="line"></div><div class="line">        analyzeFrame(m_frame);</div><div class="line">    }</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    VideoFrameRef m_frame;</div><div class="line">};</div><div class="line"></div><div class="line">PrintCallback depthPrinter;</div><div class="line"></div><div class="line"><span class="comment">// Register frame listener</span></div><div class="line">depth.addNewFrameListener(&amp;depthPrinter);</div></div><!-- fragment --><p>Need to call update.</p>
<div class="fragment"><div class="line"><span class="comment">// Wait while we&#39;re getting frames through the printer</span></div><div class="line"><span class="keywordflow">while</span> (!wasKeyboardHit())</div><div class="line">{</div><div class="line">    Sleep(100);</div><div class="line">}</div></div><!-- fragment --><p>Once we don't need to receive frame anymore, unregister callback.</p>
<div class="fragment"><div class="line">depth.removeNewFrameListener(&amp;depthPrinter);</div></div><!-- fragment --><p>After all, we need to release all resources.</p>
<div class="fragment"><div class="line"><span class="comment">//stop depth stream</span></div><div class="line">depth.stop();</div><div class="line"></div><div class="line"><span class="comment">//destroy depth stream</span></div><div class="line">depth.destroy();</div><div class="line"></div><div class="line"><span class="comment">//close device</span></div><div class="line">device.close();</div><div class="line"></div><div class="line"><span class="comment">//shutdown OpenNI</span></div><div class="line">OpenNI::shutdown();</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md45"></a>
InfraredReaderPoll</h1>
<h2><a class="anchor" id="autotoc_md46"></a>
Overview</h2>
<p>This sample show how to read an ir stream by polling.</p>
<h2><a class="anchor" id="autotoc_md47"></a>
Expected Output</h2>
<div class="image">
<img src="openni2_ir_sample_res.png" alt="openni2_ir_sample_res.png"/>
</div>
<h2><a class="anchor" id="autotoc_md48"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;OpenNI.h&gt;</span></div></div><!-- fragment --><p>Next, we need to initialize the OpenNI2 SDK, get sensor and create reader to read infrared stream.</p>
<div class="fragment"><div class="line"><span class="comment">//initialize openni sdk</span></div><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Initialize failed\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"></div><div class="line">Device device;</div><div class="line"></div><div class="line"><span class="comment">//open device</span></div><div class="line">rc = device.open(ANY_DEVICE);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t open device\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 2;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream ir;</div><div class="line"></div><div class="line"><span class="comment">//create depth stream</span></div><div class="line"><span class="keywordflow">if</span> (device.getSensorInfo(SENSOR_IR) != NULL)</div><div class="line">{</div><div class="line">    rc = ir.create(device, SENSOR_IR);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Couldn&#39;t create ir stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">return</span> 3;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//start ir stream</span></div><div class="line">rc = ir.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t start the ir stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 4;</div><div class="line">}</div></div><!-- fragment --><p>Now, let's see how to get infrared frame.</p>
<div class="fragment"><div class="line">VideoFrameRef frame;</div><div class="line"></div><div class="line"><span class="keywordflow">while</span> (!wasKeyboardHit())</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> changedStreamDummy;</div><div class="line">    VideoStream* pStream = &amp;ir;</div><div class="line"></div><div class="line">    <span class="comment">//wait a new frame</span></div><div class="line">    rc = OpenNI::waitForAnyStream(&amp;pStream, 1, &amp;changedStreamDummy, SAMPLE_READ_WAIT_TIMEOUT);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Wait failed! (timeout is %d ms)\n%s\n&quot;</span>, SAMPLE_READ_WAIT_TIMEOUT, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//get depth frame</span></div><div class="line">    rc = ir.readFrame(&amp;frame);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Read failed!\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//check if the frame format is infrared frame format</span></div><div class="line">    <span class="keywordflow">if</span> (frame.getVideoMode().getPixelFormat() != PIXEL_FORMAT_GRAY16)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Unexpected frame format\n&quot;</span>);</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="namespaceopenni.html#a15bcac1ff77c313557dd28804c31c4ff">Grayscale16Pixel</a>* pIr = (<a class="code" href="namespaceopenni.html#a15bcac1ff77c313557dd28804c31c4ff">Grayscale16Pixel</a>*)frame.getData();</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight() + 1)*frame.getWidth() / 2;</div><div class="line"></div><div class="line">    <span class="comment">//print the gray value of the middle pixel of the frame</span></div><div class="line">    printf(<span class="stringliteral">&quot;[%08llu] %8d\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)frame.getTimestamp(), pIr[middleIndex]);</div><div class="line">}</div></div><!-- fragment --><p>After all, we need to release all resources.</p>
<div class="fragment"><div class="line"><span class="comment">//stop ir stream</span></div><div class="line">ir.stop();</div><div class="line"></div><div class="line"><span class="comment">//destroy ir stream</span></div><div class="line">ir.destroy();</div><div class="line"></div><div class="line"><span class="comment">//close device</span></div><div class="line">device.close();</div><div class="line"></div><div class="line"><span class="comment">//shutdown OpenNI</span></div><div class="line">OpenNI::shutdown();</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md49"></a>
InfraredReaderEvent</h1>
<h2><a class="anchor" id="autotoc_md50"></a>
Overview</h2>
<p>This sample show how to read an ir stream by event.</p>
<h2><a class="anchor" id="autotoc_md51"></a>
Expected Output</h2>
<div class="image">
<img src="openni2_ir_sample_res.png" alt="openni2_ir_sample_res.png"/>
</div>
<h2><a class="anchor" id="autotoc_md52"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;OpenNI.h&quot;</span></div></div><!-- fragment --><p>Next, we need to initialize the OpenNI2 SDK, get sensor and create reader to read infrared stream.</p>
<div class="fragment"><div class="line"><span class="comment">//initialize openNI sdk</span></div><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Initialize failed\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//open deivce</span></div><div class="line">Device device;</div><div class="line">rc = device.open(ANY_DEVICE);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t open device\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 2;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream ir;</div><div class="line"></div><div class="line"><span class="comment">//create depth stream</span></div><div class="line"><span class="keywordflow">if</span> (device.getSensorInfo(SENSOR_IR) != NULL)</div><div class="line">{</div><div class="line">    rc = ir.create(device, SENSOR_IR);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Couldn&#39;t create ir stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//start ir stream</span></div><div class="line">rc = ir.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t start the ir stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">}</div></div><!-- fragment --><p>Then, we register a callback to receive infrared frame.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> analyzeFrame(<span class="keyword">const</span> VideoFrameRef&amp; frame)</div><div class="line">{</div><div class="line">    <a class="code" href="namespaceopenni.html#a15bcac1ff77c313557dd28804c31c4ff">Grayscale16Pixel</a>* pIR;</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight()+1)*frame.getWidth()/2;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (frame.getVideoMode().getPixelFormat())</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> PIXEL_FORMAT_GRAY16:</div><div class="line">        pIR = (<a class="code" href="namespaceopenni.html#a15bcac1ff77c313557dd28804c31c4ff">Grayscale16Pixel</a>*)frame.getData();</div><div class="line">        printf(<span class="stringliteral">&quot;[%08llu] %8d\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)frame.getTimestamp(),</div><div class="line">            pIR[middleIndex]);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        printf(<span class="stringliteral">&quot;Unknown format\n&quot;</span>);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class </span>PrintCallback : <span class="keyword">public</span> VideoStream::NewFrameListener</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keywordtype">void</span> onNewFrame(VideoStream&amp; stream)</div><div class="line">    {</div><div class="line">        stream.readFrame(&amp;m_frame);</div><div class="line"></div><div class="line">        analyzeFrame(m_frame);</div><div class="line">    }</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    VideoFrameRef m_frame;</div><div class="line">};</div><div class="line"></div><div class="line">PrintCallback irPrinter;</div><div class="line"></div><div class="line"><span class="comment">// Register frame listener</span></div><div class="line">ir.addNewFrameListener(&amp;irPrinter);</div></div><!-- fragment --><p>Need to call update.</p>
<div class="fragment"><div class="line"><span class="comment">// Wait while we&#39;re getting frames through the printer</span></div><div class="line"><span class="keywordflow">while</span> (!wasKeyboardHit())</div><div class="line">{</div><div class="line">    Sleep(100);</div><div class="line">}</div></div><!-- fragment --><p>Once we don't need to receive frame anymore, unregister callback.</p>
<div class="fragment"><div class="line">ir.removeNewFrameListener(&amp;irPrinter);</div></div><!-- fragment --><p>After all, we need to release all resources.</p>
<div class="fragment"><div class="line"><span class="comment">//stop ir stream</span></div><div class="line">ir.stop();</div><div class="line"></div><div class="line"><span class="comment">//destroy ir stream</span></div><div class="line">ir.destroy();</div><div class="line"></div><div class="line"><span class="comment">//close device</span></div><div class="line">device.close();</div><div class="line"></div><div class="line"><span class="comment">//shutdown OpenNI</span></div><div class="line">OpenNI::shutdown();</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md53"></a>
GeneratePointCloud</h1>
<h2><a class="anchor" id="autotoc_md54"></a>
Overview</h2>
<p>This sample show how to generate a point cloud from depth frame data and save the point cloud in the form of ply. In this sample, 50 depth frames are read and each depth frame is converted into a point cloud and saved in ply format.</p>
<h2><a class="anchor" id="autotoc_md55"></a>
Expected Output</h2>
<p>Generate 50 point cloud files in ply format.</p>
<h2><a class="anchor" id="autotoc_md56"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;OpenNI.h&quot;</span></div></div><!-- fragment --><p>Next, declare a structure to hold the internal reference data and define a global object to hold the internal reference data retrieved from the camera.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>xnIntrinsic_Params</div><div class="line">{</div><div class="line">    xnIntrinsic_Params() :</div><div class="line">        c_x(320.0), c_y(240.0), f_x(480.0), f_y(480.0)</div><div class="line">    {}</div><div class="line"></div><div class="line">    xnIntrinsic_Params(<span class="keywordtype">float</span> c_x_, <span class="keywordtype">float</span> c_y_, <span class="keywordtype">float</span> f_x_, <span class="keywordtype">float</span> f_y_) :</div><div class="line">        c_x(c_x_), c_y(c_y_), f_x(f_x_),f_y(f_y_)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keywordtype">float</span> c_x; <span class="comment">//u axis Normalized focal length</span></div><div class="line">    <span class="keywordtype">float</span> c_y; <span class="comment">//v axis Normalized focal length</span></div><div class="line">    <span class="keywordtype">float</span> f_x; <span class="comment">//x coordinate of Principal point</span></div><div class="line">    <span class="keywordtype">float</span> f_y; <span class="comment">//y coordinate of Principal point</span></div><div class="line">}xIntrinsic_Params;</div><div class="line"></div><div class="line">xIntrinsic_Params g_IntrinsicParam; </div></div><!-- fragment --><p> Next, we need to initialize the OpenNI2 SDK, open the device, create and launch the depth stream and get the camera internal parameters. </p><div class="fragment"><div class="line"><span class="comment">//initialize openNI sdk</span></div><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Initialize failed\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//open deivce</span></div><div class="line">Device device;</div><div class="line">rc = device.open(ANY_DEVICE);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t open device\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 2;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream depth;</div><div class="line"></div><div class="line"><span class="comment">//create depth stream</span></div><div class="line"><span class="keywordflow">if</span> (device.getSensorInfo(SENSOR_DEPTH) != NULL)</div><div class="line">{</div><div class="line">    rc = depth.create(device, SENSOR_DEPTH);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Couldn&#39;t create depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//start depth stream</span></div><div class="line">rc = depth.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t start the depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">}</div><div class="line"></div><div class="line">PrintCallback depthPrinter;</div><div class="line"></div><div class="line"><span class="comment">// Register frame listener</span></div><div class="line">depth.addNewFrameListener(&amp;depthPrinter);</div><div class="line"></div><div class="line"><span class="comment">//get intrinsic parameter from device</span></div><div class="line">getCameraParams(device, g_IntrinsicParam);</div></div><!-- fragment --><p> The function getCameraParams to get the camera internal parameters is defined as follows:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> getCameraParams(<a class="code" href="classopenni_1_1_device.html">openni::Device</a>&amp; Device, xIntrinsic_Params&amp; IrParam)</div><div class="line">{</div><div class="line">    OBCameraParams cameraParam;</div><div class="line">    <span class="keywordtype">int</span> dataSize = <span class="keyword">sizeof</span>(cameraParam);</div><div class="line">    memset(&amp;cameraParam, 0, <span class="keyword">sizeof</span>(cameraParam));</div><div class="line">    openni::Status rc = Device.<a class="code" href="classopenni_1_1_device.html#ae9dd16a0002e21d95fc75e6d1adb61d2">getProperty</a>(openni::OBEXTENSION_ID_CAM_PARAMS, (uint8_t *)&amp;cameraParam, &amp;dataSize);</div><div class="line">    <span class="keywordflow">if</span> (rc != openni::STATUS_OK)</div><div class="line">    {</div><div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Error:&quot;</span> &lt;&lt; <a class="code" href="classopenni_1_1_open_n_i.html#a01fd4df5c93eaf9a9437bbc4c942130a">openni::OpenNI::getExtendedError</a>() &lt;&lt; std::endl;</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line">    IrParam.f_x = cameraParam.l_intr_p[0]; </div><div class="line">    IrParam.f_y = cameraParam.l_intr_p[1]; </div><div class="line">    IrParam.c_x = cameraParam.l_intr_p[2];</div><div class="line">    IrParam.c_y = cameraParam.l_intr_p[3];</div><div class="line"></div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;IrParam.f_x = &quot;</span> &lt;&lt; IrParam.f_x &lt;&lt; std::endl;</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;IrParam.f_y = &quot;</span> &lt;&lt; IrParam.f_y &lt;&lt; std::endl;</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;IrParam.c_x = &quot;</span> &lt;&lt; IrParam.c_x &lt;&lt; std::endl;</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;IrParam.c_y = &quot;</span> &lt;&lt; IrParam.c_y &lt;&lt; std::endl;</div><div class="line"></div><div class="line">}</div></div><!-- fragment --><p> We then register a callback to receive the depth stream data frames and convert the depth data frames to point cloud storage.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> g_imageCount = 0; <span class="comment">//record total frame number</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> analyzeFrame(<span class="keyword">const</span> VideoFrameRef&amp; frame)</div><div class="line">{</div><div class="line">    <a class="code" href="namespaceopenni.html#ab2403242071ff06fc6fe18c0c6111d0f">DepthPixel</a>* pDepth;</div><div class="line"></div><div class="line">    <span class="comment">//construct pointcloud file name</span></div><div class="line">    <span class="keywordtype">char</span> plyFileName[256] = { 0 };</div><div class="line">    g_imageCount++;</div><div class="line">    sprintf_s(plyFileName, <span class="stringliteral">&quot;pointcloud_%d.ply&quot;</span>, g_imageCount);</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight()+1)*frame.getWidth()/2;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (frame.getVideoMode().getPixelFormat())</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> PIXEL_FORMAT_DEPTH_1_MM:</div><div class="line">        pDepth = (<a class="code" href="namespaceopenni.html#ab2403242071ff06fc6fe18c0c6111d0f">DepthPixel</a>*)frame.getData();</div><div class="line">        printf(<span class="stringliteral">&quot;[%08llu] %8d\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)frame.getTimestamp(),</div><div class="line">            pDepth[middleIndex]);</div><div class="line">        <span class="comment">//convert depth frame to pointcloud file </span></div><div class="line">        convertDepthToPointCloud(pDepth, frame.getWidth(), frame.getHeight(), plyFileName);</div><div class="line"></div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        printf(<span class="stringliteral">&quot;Unknown format\n&quot;</span>);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class </span>PrintCallback : <span class="keyword">public</span> VideoStream::NewFrameListener</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keywordtype">void</span> onNewFrame(VideoStream&amp; stream)</div><div class="line">    {</div><div class="line">        stream.readFrame(&amp;m_frame);</div><div class="line"></div><div class="line">        analyzeFrame(m_frame);</div><div class="line">    }</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    VideoFrameRef m_frame;</div><div class="line">};</div></div><!-- fragment --><p>Converts the depth of the frame to the method of point cloud convertDepthToPointCloud are defined as follows:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define MIN_DISTANCE 20  // Unit(mm)</span></div><div class="line"><span class="preprocessor">#define MAX_DISTANCE 4000 //Unit(mm)</span></div><div class="line"><span class="preprocessor">#define RESOULTION_X 640.0  //calibration resolution</span></div><div class="line"><span class="preprocessor">#define RESOULTION_Y 480.0  //calibration resolution</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> convertDepthToPointCloud(<span class="keyword">const</span> uint16_t *pDepth, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height,<span class="keyword">const</span> <span class="keywordtype">char</span> *ply_filename)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (NULL == pDepth)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;depth frame is NULL!&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//convert depth frame to pointcloud file </span></div><div class="line">    FILE *fp;</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> res = fopen_s(&amp;fp, ply_filename, <span class="stringliteral">&quot;w&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> valid_count = 0;</div><div class="line">    uint16_t max_depth = MAX_DISTANCE;</div><div class="line">    uint16_t min_depth = MIN_DISTANCE;</div><div class="line"></div><div class="line">    <span class="comment">//count valid frame number</span></div><div class="line">    <span class="keywordtype">int</span> img_size = width * height;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> v = 0; v &lt; height; ++v)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> u = 0; u &lt; width; ++u)</div><div class="line">        {</div><div class="line">            uint16_t depth = pDepth[v * width + u];</div><div class="line">            <span class="keywordflow">if</span> (depth &lt;= 0 || depth &lt; min_depth || depth &gt; max_depth)</div><div class="line">                <span class="keywordflow">continue</span>;</div><div class="line"></div><div class="line">            valid_count += 1;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//head of ply file</span></div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;ply\n&quot;</span>);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;format ascii 1.0\n&quot;</span>);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;element vertex %d\n&quot;</span>, valid_count);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;property float x\n&quot;</span>);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;property float y\n&quot;</span>);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;property float z\n&quot;</span>);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;property uchar red\n&quot;</span>);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;property uchar green\n&quot;</span>);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;property uchar blue\n&quot;</span>);</div><div class="line">    fprintf(fp, <span class="stringliteral">&quot;end_header\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordtype">float</span> world_x, world_y, world_z;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> v = 0; v &lt; height; ++v)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> u = 0; u &lt; width; ++u)</div><div class="line">        {</div><div class="line">            uint16_t depth = pDepth[v * width + u];</div><div class="line">            <span class="keywordflow">if</span> (depth &lt;= 0 || depth &lt; min_depth || depth &gt; max_depth)</div><div class="line">                <span class="keywordflow">continue</span>;</div><div class="line"></div><div class="line">            <span class="comment">//scale resolution</span></div><div class="line">            <span class="keywordtype">float</span> fdx = g_IntrinsicParam.f_x * ((float)(width) / RESOULTION_X);</div><div class="line">            <span class="keywordtype">float</span> fdy = g_IntrinsicParam.f_y * ((float)(height) / RESOULTION_Y);</div><div class="line">            <span class="keywordtype">float</span> u0 = g_IntrinsicParam.c_x * ((float)(width)/ RESOULTION_X);</div><div class="line">            <span class="keywordtype">float</span> v0 = g_IntrinsicParam.c_y * ((float)(height) / RESOULTION_Y);</div><div class="line"></div><div class="line">            <span class="keywordtype">float</span> tx = (u - u0) / fdx;</div><div class="line">            <span class="keywordtype">float</span> ty = (v - v0) / fdy;</div><div class="line"></div><div class="line">            world_x = depth * tx;</div><div class="line">            world_y = depth * ty;</div><div class="line">            world_z = depth;</div><div class="line">            fprintf(fp, <span class="stringliteral">&quot;%f %f %f 255 255 255\n&quot;</span>, world_x, world_y, world_z);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    fclose(fp);</div><div class="line">}</div></div><!-- fragment --><p>Need to call update.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define MAX_FRAME_COUNT 50</span></div><div class="line"></div><div class="line"><span class="comment">// Wait while we&#39;re getting frames through the printer</span></div><div class="line"><span class="keywordflow">while</span> (MAX_FRAME_COUNT &gt; g_imageCount)</div><div class="line">{</div><div class="line">    Sleep(100);</div><div class="line">}</div></div><!-- fragment --><p>Once we don't need to receive frame anymore, unregister callback.</p>
<div class="fragment"><div class="line">depth.removeNewFrameListener(&amp;depthPrinter);</div></div><!-- fragment --><p>After all, we need to release all resources.</p>
<div class="fragment"><div class="line"><span class="comment">//stop depth stream</span></div><div class="line">depth.stop();</div><div class="line"></div><div class="line"><span class="comment">//destroy depth stream</span></div><div class="line">depth.destroy();</div><div class="line"></div><div class="line"><span class="comment">//close device</span></div><div class="line">device.close();</div><div class="line"></div><div class="line"><span class="comment">//shutdown OpenNI</span></div><div class="line">OpenNI::shutdown();</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md57"></a>
InfraredOniFileRecorder</h1>
<h2><a class="anchor" id="autotoc_md58"></a>
Overview</h2>
<p>This sample show how to save an ir stream as an Oni file . This sample demonstrates reading 100 IR data frames and saving those 100 IR data frames to files in Oni format.</p>
<h2><a class="anchor" id="autotoc_md59"></a>
Expected Output</h2>
<p>Generate a file called "ir.oni".</p>
<h2><a class="anchor" id="autotoc_md60"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;OpenNI.h&gt;</span></div></div><!-- fragment --><p>Next, we need to initialize the OpenNI2 SDK, get sensor and create reader to read infrared stream. </p><div class="fragment"><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Initialize failed\n&quot;</span> &lt;&lt; OpenNI::getExtendedError() &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line">Device device;</div><div class="line">rc = device.<a class="code" href="classopenni_1_1_device.html#a2240eaf483ea04506f320f3cd963ca62">open</a>(ANY_DEVICE);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Couldn&#39;t open device\n&quot;</span> &lt;&lt; OpenNI::getExtendedError() &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream ir;</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (device.getSensorInfo(SENSOR_IR) != NULL)</div><div class="line">{</div><div class="line">    rc = ir.create(device, SENSOR_IR);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Couldn&#39;t create  ir stream\n&quot;</span> &lt;&lt; OpenNI::getExtendedError() &lt;&lt; std::endl;</div><div class="line">        <span class="keywordflow">return</span> rc;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line">rc = ir.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Couldn&#39;t start the depth stream\n&quot;</span> &lt;&lt; OpenNI::getExtendedError() &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> rc;</div><div class="line">}</div></div><!-- fragment --><p>Next, create the recorder, add the IR stream to the recorder, and start the recorder.</p>
<div class="fragment"><div class="line"><span class="comment">//define a recorder</span></div><div class="line">Recorder recordIr;</div><div class="line"></div><div class="line"><span class="keywordtype">char</span> irPathFile[256] = { 0 };</div><div class="line">sprintf_s(irPathFile, <span class="stringliteral">&quot;ir.oni&quot;</span>);<span class="comment">//irPathFile is the path to svae oni file</span></div><div class="line"></div><div class="line"><span class="comment">//create recorder, a file path is needed</span></div><div class="line">rc = recordIr.create(irPathFile);</div><div class="line"><span class="keywordflow">if</span> (STATUS_OK != rc)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;create ir video recorder failed.&quot;</span> &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//attach ir stream to recordIr</span></div><div class="line">rc = recordIr.attach(ir);</div><div class="line"><span class="keywordflow">if</span> (STATUS_OK != rc)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;attach ir video recorder failed.&quot;</span> &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//start recorder</span></div><div class="line">rc = recordIr.start();</div><div class="line"><span class="keywordflow">if</span> (STATUS_OK != rc)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;start ir video recorder failed.&quot;</span> &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> rc;</div><div class="line">}</div></div><!-- fragment --><p>Next, the polling mode reads 100 frames of data. </p><div class="fragment"><div class="line">VideoFrameRef frame;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> count = 0;</div><div class="line"><span class="keywordflow">while</span> (MAX_RECORD_FRAME_NUM &gt; count)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> changedStreamDummy;</div><div class="line">    VideoStream* pStream = &amp;ir;</div><div class="line">    rc = OpenNI::waitForAnyStream(&amp;pStream, 1, &amp;changedStreamDummy, SAMPLE_READ_WAIT_TIMEOUT);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Wait failed! (timeout is &quot;</span> &lt;&lt; SAMPLE_READ_WAIT_TIMEOUT &lt;&lt; <span class="stringliteral">&quot;ms)\n&quot;</span> &lt;&lt; OpenNI::getExtendedError();</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    rc = ir.readFrame(&amp;frame);</div><div class="line">    <span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">    {</div><div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Read failed!\n&quot;</span> &lt;&lt; OpenNI::getExtendedError() &lt;&lt; std::endl;</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (frame.getVideoMode().getPixelFormat() != PIXEL_FORMAT_GRAY16)</div><div class="line">    {</div><div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Unexpected frame format\n&quot;</span>;</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="namespaceopenni.html#a15bcac1ff77c313557dd28804c31c4ff">Grayscale16Pixel</a>* pIR = (<a class="code" href="namespaceopenni.html#a15bcac1ff77c313557dd28804c31c4ff">Grayscale16Pixel</a>*)frame.getData();</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight() + 1)*frame.getWidth() / 2;</div><div class="line"></div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;[&quot;</span> &lt;&lt; std::setw(8) &lt;&lt; std::setiosflags(std::ios::right) &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; (<span class="keywordtype">long</span> long)frame.getTimestamp() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span> &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;</div><div class="line">    std::cout &lt;&lt; std::setw(8) &lt;&lt; std::setfill(<span class="charliteral">&#39; &#39;</span>) &lt;&lt; pIR[middleIndex] &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    count++;</div><div class="line">}</div></div><!-- fragment --><p>Finally, close the destroy recorder and the stream and device.</p>
<div class="fragment"><div class="line"><span class="comment">//stop and destroy recorder</span></div><div class="line">recordIr.stop();</div><div class="line">recordIr.destroy();</div><div class="line"></div><div class="line">ir.stop();</div><div class="line">ir.destroy();</div><div class="line">device.close();</div><div class="line">OpenNI::shutdown();</div><div class="line"></div><div class="line"><span class="keywordflow">return</span> 0;</div></div><!-- fragment --> <h1><a class="anchor" id="autotoc_md61"></a>
InfraredOniFileReader</h1>
<h2><a class="anchor" id="autotoc_md62"></a>
Overview</h2>
<p>This sample show how to read the Oni file of an ir stream.</p>
<h2><a class="anchor" id="autotoc_md63"></a>
Expected Output</h2>
<div class="image">
<img src="openni2_ir_sample_res.png" alt="openni2_ir_sample_res.png"/>
</div>
<h2><a class="anchor" id="autotoc_md64"></a>
Code Overview</h2>
<p>First, we include the header file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;OpenNI.h&gt;</span></div></div><!-- fragment --><p>Next, we need to initialize the OpenNI2 SDK, open the file device ir.oni, and create and start the ir stream on the file device.</p>
<div class="fragment"><div class="line">Status rc = OpenNI::initialize();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Initialize failed\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">char</span> irPathFile[256] = { 0 };</div><div class="line">sprintf_s(irPathFile, <span class="stringliteral">&quot;ir.oni&quot;</span>);</div><div class="line"></div><div class="line">Device device;</div><div class="line"><span class="comment">//open file device</span></div><div class="line">rc = device.<a class="code" href="classopenni_1_1_device.html#a2240eaf483ea04506f320f3cd963ca62">open</a>(irPathFile);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t open device\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 2;</div><div class="line">}</div><div class="line"></div><div class="line">VideoStream ir;</div><div class="line"></div><div class="line">rc = ir.create(device, SENSOR_IR);</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t create  ir stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 3;</div><div class="line">}</div><div class="line"></div><div class="line">rc = ir.start();</div><div class="line"><span class="keywordflow">if</span> (rc != STATUS_OK)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Couldn&#39;t start the depth stream\n%s\n&quot;</span>, OpenNI::getExtendedError());</div><div class="line">    <span class="keywordflow">return</span> 4;</div><div class="line">}</div></div><!-- fragment --><p>Next, get the total number of frames in the playback control object and the oni file device, and read the data frames from the file device according to the index.</p>
<div class="fragment"><div class="line"><span class="comment">//get PlaybackControl object</span></div><div class="line"><a class="code" href="classopenni_1_1_playback_control.html">openni::PlaybackControl</a> * irPlaybackCtrl = device.getPlaybackControl();</div><div class="line"></div><div class="line"><span class="comment">//get total frame number in the file device</span></div><div class="line"><span class="keywordtype">int</span> totalFrameNum = irPlaybackCtrl-&gt;<a class="code" href="classopenni_1_1_playback_control.html#a3bea28eb44d8553dc15d188ffef1955b">getNumberOfFrames</a>(ir);</div><div class="line"></div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; totalFrameNum; k++)</div><div class="line">{</div><div class="line">    irPlaybackCtrl-&gt;<a class="code" href="classopenni_1_1_playback_control.html#a99d10ea20ad021cfe056ff225d31d840">seek</a>(ir, k);</div><div class="line">    VideoFrameRef frame;</div><div class="line"></div><div class="line">    ir.readFrame(&amp;frame);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (frame.getVideoMode().getPixelFormat() != PIXEL_FORMAT_GRAY16)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Unexpected frame format\n&quot;</span>);</div><div class="line">        <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="namespaceopenni.html#a15bcac1ff77c313557dd28804c31c4ff">Grayscale16Pixel</a>* pIR = (<a class="code" href="namespaceopenni.html#a15bcac1ff77c313557dd28804c31c4ff">Grayscale16Pixel</a>*)frame.getData();</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> middleIndex = (frame.getHeight() + 1)*frame.getWidth() / 2;</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;[%08llu] %8d\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)frame.getTimestamp(), pIR[middleIndex]);</div><div class="line">}</div></div><!-- fragment --><p>Finally, destroy the stream and close the file device.</p>
<div class="fragment"><div class="line">ir.stop();</div><div class="line">ir.destroy();</div><div class="line">device.close();</div><div class="line">OpenNI::shutdown();</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
  <strong>© 2020 <a href="https://orbbec3d.com/">Orbbec 3D</a></strong> All Rights Reserved.
</small></address>
</body>
</html>
